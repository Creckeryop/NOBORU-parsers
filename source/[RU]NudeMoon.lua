NudeMoon = Parser:new("Nude-Moon", "https://nude-moon.net", "RUS", "NUDEMOONRU", 5)

NudeMoon.Filters = {
	{
		Name = "Жанр",
		Type = "check",
		Tags = {
			"Анал",
			"Без цензуры",
			"Беременные",
			"Близняшки",
			"Большие груди",
			"В бассейне",
			"В больнице",
			"В ванной",
			"В общественном месте",
			"В первый раз",
			"В транспорте",
			"В туалете",
			"Гарем",
			"Гипноз",
			"Горничные",
			"Горячий источник",
			"Групповой секс",
			"Драма",
			"Запредельное",
			"Золотой дождь",
			"Зрелые женщины",
			"Идолы",
			"Извращение",
			"Измена",
			"Имеют парня",
			"Клизма",
			"Колготки",
			"Комиксы",
			"Комиксы 3D",
			"Косплей",
			"Мастурбация",
			"Мерзкий мужик",
			"Много спермы",
			"Молоко",
			"Монстры",
			"На камеру",
			"На природе",
			"Обычный секс",
			"Огромный член",
			"Пляж",
			"Подглядывание",
			"Принуждение",
			"Продажность",
			"Пьяные",
			"Рабыни",
			"Романтика",
			"С ушками",
			"Секс игрушки",
			"Спящие",
			"Страпон",
			"Студенты",
			"Суккуб",
			"Тентакли",
			"Толстушки",
			"Трапы",
			"Ужасы",
			"Униформа",
			"Учитель и ученик",
			"Фемдом",
			"Фетиш",
			"Фурри",
			"Футанари",
			"Футфетиш",
			"Фэнтези",
			"Цветная",
			"Чикан",
			"Чулки",
			"Шимейл",
			"Эксгибиционизм",
			"Юмор",
			"Юри",
			"Яой",
			"Ahegao",
			"BDSM",
			"Ganguro",
			"Gender bender",
			"Megane",
			"Mind break",
			"Monstergirl",
			"Netorare",
			"Nipple penetration",
			"Titsfuck",
			"X-ray"
		}
	}
}

NudeMoon.Keys = {
	["Анал"] = "анал",
	["Без цензуры"] = "без цензуры",
	["Беременные"] = "беременные",
	["Близняшки"] = "близняшки",
	["Большие груди"] = "большие груди",
	["В бассейне"] = "в бассейне",
	["В больнице"] = "в больнице",
	["В ванной"] = "в ванной",
	["В общественном месте"] = "в общественном месте",
	["В первый раз"] = "в первый раз",
	["В транспорте"] = "в транспорте",
	["В туалете"] = "в туалете",
	["Гарем"] = "гарем",
	["Гипноз"] = "гипноз",
	["Горничные"] = "горничные",
	["Горячий источник"] = "горячий источник",
	["Групповой секс"] = "групповой секс",
	["Драма"] = "драма",
	["Запредельное"] = "запредельное",
	["Золотой дождь"] = "золотой дождь",
	["Зрелые женщины"] = "зрелые женщины",
	["Идолы"] = "идолы",
	["Извращение"] = "извращение",
	["Измена"] = "измена",
	["Имеют парня"] = "имеют парня",
	["Клизма"] = "клизма",
	["Колготки"] = "колготки",
	["Комиксы"] = "комиксы",
	["Комиксы 3D"] = "комиксы 3D",
	["Косплей"] = "косплей",
	["Мастурбация"] = "мастурбация",
	["Мерзкий мужик"] = "мерзкий мужик",
	["Много спермы"] = "много спермы",
	["Молоко"] = "молоко",
	["Монстры"] = "монстры",
	["На камеру"] = "на камеру",
	["На природе"] = "на природе",
	["Обычный секс"] = "обычный секс",
	["Огромный член"] = "огромный член",
	["Пляж"] = "пляж",
	["Подглядывание"] = "подглядывание",
	["Принуждение"] = "принуждение",
	["Продажность"] = "продажность",
	["Пьяные"] = "пьяные",
	["Рабыни"] = "рабыни",
	["Романтика"] = "романтика",
	["С ушками"] = "с ушками",
	["Секс игрушки"] = "секс игрушки",
	["Спящие"] = "спящие",
	["Страпон"] = "страпон",
	["Студенты"] = "студенты",
	["Суккуб"] = "суккуб",
	["Тентакли"] = "тентакли",
	["Толстушки"] = "толстушки",
	["Трапы"] = "трапы",
	["Ужасы"] = "ужасы",
	["Униформа"] = "униформа",
	["Учитель и ученик"] = "учитель и ученик",
	["Фемдом"] = "фемдом",
	["Фетиш"] = "фетиш",
	["Фурри"] = "фурри",
	["Футанари"] = "футанари",
	["Футфетиш"] = "футфетиш",
	["Фэнтези"] = "фэнтези",
	["Цветная"] = "цветная",
	["Чикан"] = "чикан",
	["Чулки"] = "чулки",
	["Шимейл"] = "шимейл",
	["Эксгибиционизм"] = "эксгибиционизм",
	["Юмор"] = "юмор",
	["Юри"] = "юри",
	["Яой"] = "яой",
	["Ahegao"] = "ahegao",
	["BDSM"] = "BDSM",
	["Ganguro"] = "ganguro",
	["Gender bender"] = "gender bender",
	["Megane"] = "megane",
	["Mind break"] = "mind break",
	["Monstergirl"] = "monstergirl",
	["Netorare"] = "netorare",
	["Nipple penetration"] = "nipple penetration",
	["Titsfuck"] = "titsfuck",
	["X-ray"] = "x-ray"
}

NudeMoon.NSFW = true

local function stringify(string)
	return string:gsub(
		"&#([^;]-);",
		function(a)
			local number = tonumber("0" .. a) or tonumber(a)
			return number and u8c(number) or "&#" .. a .. ";"
		end
	):gsub(
		"&(.-);",
		function(a)
			return HTML_entities and HTML_entities[a] and u8c(HTML_entities[a]) or "&" .. a .. ";"
		end
	)
end

local function downloadContent(link)
	local f = {}
	Threads.insertTask(
		f,
		{
			Type = "StringRequest",
			Link = link,
			Table = f,
			Index = "text",
			Header1 = "referer: https://www.google.com/",
			Header2 = "cookie: fusion_user=323815.769acb94801026e2f219844529cf51d0"
		}
	)
	while Threads.check(f) do
		coroutine.yield(false)
	end
	return f.text or ""
end

local function find(table, str)
	for k, v in pairs(table) do
		if v == str then
			return true
		end
	end
	return false
end

function NudeMoon:getManga(link, dt, filter)
	local content = downloadContent(link)
	dt.NoPages = true
	local regex = '<td colspan.-<a[^>]-href="(.-)".-title="(.-)".-src="(.-)"'
	if filter then
		regex = regex .. ".-tag%-links(.-)</span>"
	end
	for Link, Name, ImageLink, Tags in content:gmatch(regex) do
		local add = true
		if filter then
			local tags = {}
			for tag in Tags:gmatch("/tag/.->(.-)</a>") do
				tags[#tags + 1] = AnsiToUtf8(tag)
			end
			for k, v in pairs(filter[1]) do
				if not find(tags, self.Keys[v]) then
					add = false
					break
				end
			end
		end
		if add then
			dt[#dt + 1] = CreateManga(stringify(AnsiToUtf8(Name)), Link, ImageLink:find("^https") and ImageLink or (self.Link .. ImageLink), self.ID, self.Link .. Link)
		end
		dt.NoPages = false
		if add then
			coroutine.yield(false)
		end
	end
end

function NudeMoon:getLatestManga(page, dt)
	self:getManga(self.Link .. "/all_manga?rowstart=" .. ((page - 1) * 30), dt)
end

function NudeMoon:getPopularManga(page, dt)
	self:getManga(self.Link .. "/all_manga?views&rowstart=" .. ((page - 1) * 30), dt)
end

function NudeMoon:searchManga(data, page, dt, tags)
	local stext = {}
	if data == "" and tags and #tags > 0 and #tags[1] > 0 then
		local search = ""
		for k, v in pairs(tags[1]) do
			search =
				search ..
				self.Keys[v]:gsub(" ", "_"):gsub(
					".",
					function(a)
						return "%%" .. string.format("%x", string.byte(a))
					end
				) ..
					"_"
		end
		self:getManga(self.Link .. "/tags/" .. search .. "&rowstart=" .. ((page - 1) * 30), dt)
	else
		for c in it_utf8(data) do
			if utf8ascii[c] then
				stext[#stext + 1] = utf8ascii[c]
			else
				stext[#stext + 1] = c
			end
		end
		stext = table.concat(stext)
		self:getManga(self.Link .. "/search?stext=" .. stext .. "&rowstart=" .. ((page - 1) * 30), dt, tags)
	end
end

function NudeMoon:getChapters(manga, dt)
	local content = downloadContent(self.Link .. manga.Link)
	local link = content:match('"(/vse_glavy/[^"]-)"')
	if link then
		local t = {}
		self:getManga(self.Link .. link, t)
		for i = #t, 1, -1 do
			local m = t[i]
			dt[#dt + 1] = {
				Name = stringify(m.Name),
				Link = m.Link:gsub("^(/%d*)", "%1-online"),
				Pages = {},
				Manga = manga
			}
		end
	else
		dt[#dt + 1] = {
			Name = stringify(manga.Name),
			Link = manga.Link:gsub("^(/%d*)", "%1-online"),
			Pages = {},
			Manga = manga
		}
	end
end

function NudeMoon:prepareChapter(chapter, dt)
	local content = downloadContent(self.Link .. chapter.Link .. "?page=1")
	for link in content:gmatch("images%[%d-%].src = '(.-)';") do
		if link:find("^https") then
			dt[#dt + 1] = link
		else
			dt[#dt + 1] = self.Link .. link
		end
	end
end

function NudeMoon:loadChapterPage(link, dt)
	dt.Link = link
end
